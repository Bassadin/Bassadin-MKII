name: Build, test and deploy to https://bassadin.de/

on:
    push:
        branches: [master]

jobs:
    cypress-test:
        name: Cypress tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Cypress run
              uses: cypress-io/github-action@v4
              with:
                  component: true
    build:
        name: Yarn build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-node@master
              with:
                  node-version: 16
            - name: Yarn module install
              run: yarn install --frozen-lockfile
            - name: Yarn build
              run: yarn run build
            - uses: actions/upload-artifact@master
              with:
                  name: build-artifact
                  path: dist/
    deploy:
        needs:
            - cypress-test
            - build
        runs-on: ubuntu-latest
        name: Deploy to FTP Server
        steps:
            - uses: actions/download-artifact@master
              with:
                  name: build-artifact
                  path: dist/
            - name: Deploy to FTP Server
              uses: SamKirkland/FTP-Deploy-Action@4.0.0
              with:
                  server: ha01s018.org-dns.com
                  username: bassadin_root_website
                  password: ${{ secrets.FTP_Password }}
                  protocol: ftps
                  local-dir: dist/
                  security: strict
    check-lighthouse:
        name: Perform Google Lighthouse Check
        runs-on: ubuntu-latest
        needs: deploy
        steps:
            - name: Create artifacts dir
              run: mkdir -p ${{ github.workspace }}/tmp/artifacts
            - name: Lighthouse audit
              uses: foo-software/lighthouse-check-action@master
              with:
                  outputDirectory: ${{ github.workspace }}/tmp/artifacts
                  urls: "https://bassadin.de/"
            - name: Upload artifacts
              uses: actions/upload-artifact@master
              with:
                  name: Lighthouse reports
                  path: ${{ github.workspace }}/tmp/artifacts
